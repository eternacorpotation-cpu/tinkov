import React, { useState, useEffect, useRef } from 'react';
import { RotateCcw, Brain, Trophy, ChevronRight } from 'lucide-react';

const vocabulary = [
  { id: 1, de: "Girokonto", en: "current account / checking account", cat: "Konten" },
  { id: 2, de: "Überziehungskredit, Dispokredit", en: "overdraft facility", cat: "Konten" },
  { id: 3, de: "etw. (Gebühr usw.) verlangen, etw. berechnen", en: "to charge sth", cat: "Gebühren" },
  { id: 4, de: "Überweisung, Geldanweisung", en: "money transfer", cat: "Transaktionen" },
  { id: 5, de: "Gebühr", en: "fee", cat: "Gebühren" },
  { id: 6, de: "Pauschalgebühr, Pauschale", en: "flat fee", cat: "Gebühren" },
  { id: 7, de: "etw. berechnen", en: "to calculate sth", cat: "Gebühren" },
  { id: 8, de: "Zusatzgebühr", en: "additional charge", cat: "Gebühren" },
  { id: 9, de: "Abhebung", en: "withdrawal", cat: "Transaktionen" },
  { id: 10, de: "unterschreiben", en: "to sign", cat: "Dokumente" },
  { id: 11, de: "bis (zu)", en: "up to", cat: "Allgemein" },
  { id: 12, de: "etw. sparen", en: "to save sth", cat: "Transaktionen" },
  { id: 13, de: "Obergrenze, Limit", en: "limit", cat: "Allgemein" },
  { id: 14, de: "Informationsblatt, Broschüre, Prospekt", en: "leaflet", cat: "Dokumente" },
  { id: 15, de: "gültig", en: "valid", cat: "Dokumente" },
  { id: 16, de: "Reisepass", en: "passport", cat: "Dokumente" },
  { id: 17, de: "Aufenthaltserlaubnis", en: "residence permit", cat: "Dokumente" },
  { id: 18, de: "Arbeitserlaubnis", en: "work permit", cat: "Dokumente" },
  { id: 19, de: "Anmeldebescheinigung", en: "proof of registration", cat: "Dokumente" },
  { id: 20, de: "Bescheinigung, Zertifikat", en: "certificate", cat: "Dokumente" },
  { id: 21, de: "Arbeitsvertrag", en: "work contract", cat: "Dokumente" },
  { id: 22, de: "Gehaltsabrechnung", en: "salary statement", cat: "Dokumente" },
  { id: 23, de: "Einkommensnachweis", en: "proof of income", cat: "Dokumente" },
  { id: 24, de: "etw. einreichen", en: "to submit sth", cat: "Dokumente" },
  { id: 25, de: "monatlich, Monats-", en: "monthly", cat: "Allgemein" },
  { id: 26, de: "Ausweisdokument", en: "personal identification", cat: "Dokumente" },
  { id: 27, de: "Identitätsnachweis", en: "proof of identity", cat: "Dokumente" },
  { id: 28, de: "Einkommen, Einkünfte", en: "income", cat: "Allgemein" },
  { id: 29, de: "Überweisung", en: "bank transfer", cat: "Transaktionen" },
  { id: 30, de: "Lastschrift, Abbuchung", en: "direct debit", cat: "Transaktionen" },
  { id: 31, de: "Dauerauftrag", en: "standing order", cat: "Transaktionen" },
  { id: 32, de: "Bankgeschäfte", en: "bank transactions", cat: "Transaktionen" },
  { id: 33, de: "Gemeinschaftskonto", en: "joint account", cat: "Konten" },
  { id: 34, de: "etw. jds. Konto gutschreiben", en: "to credit sb's account with sth", cat: "Transaktionen" },
  { id: 35, de: "Sparkonto", en: "savings account", cat: "Konten" },
  { id: 36, de: "Termingeldkonto, Festgeldkonto", en: "time deposit account", cat: "Konten" },
  { id: 37, de: "Zins(en)", en: "interest", cat: "Allgemein" },
  { id: 38, de: "Zinssatz", en: "interest rate", cat: "Allgemein" },
  { id: 39, de: "fest, fix", en: "fixed", cat: "Allgemein" },
  { id: 40, de: "Laufzeit", en: "term", cat: "Allgemein" }
];

const categories = ["Alle", "Konten", "Gebühren", "Dokumente", "Transaktionen", "Allgemein"];

export default function App() {
  const [selectedCategory, setSelectedCategory] = useState("Alle");
  const [currentDeck, setCurrentDeck] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);
  const [learnedIds, setLearnedIds] = useState(new Set());
  const [failedIds, setFailedIds] = useState(new Set());
  const [isFinished, setIsFinished] = useState(false);
  const [isReviewMode, setIsReviewMode] = useState(false);

  // Swipe State
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const cardRef = useRef(null);

  useEffect(() => {
    startNewSession(selectedCategory);
  }, [selectedCategory]);

  const startNewSession = (category) => {
    let filtered = category === "Alle" 
      ? [...vocabulary] 
      : vocabulary.filter(item => item.cat === category);
    filtered = filtered.sort(() => Math.random() - 0.5);
    setCurrentDeck(filtered);
    resetStats();
    setIsReviewMode(false);
  };

  const startReviewFailed = () => {
    const failedOnes = vocabulary.filter(item => failedIds.has(item.id));
    setCurrentDeck(failedOnes.sort(() => Math.random() - 0.5));
    resetStats();
    setIsReviewMode(true);
  };

  const resetStats = () => {
    setCurrentIndex(0);
    setIsFlipped(false);
    setLearnedIds(new Set());
    setFailedIds(new Set());
    setIsFinished(false);
    setDragOffset({ x: 0, y: 0 });
  };

  const handleResponse = (isCorrect) => {
    const currentItem = currentDeck[currentIndex];
    if (isCorrect) {
      setLearnedIds(prev => new Set(prev).add(currentItem.id));
      setFailedIds(prev => {
        const next = new Set(prev);
        next.delete(currentItem.id);
        return next;
      });
    } else {
      setFailedIds(prev => new Set(prev).add(currentItem.id));
    }

    // Delay next card for animation to complete
    setTimeout(() => {
      if (currentIndex < currentDeck.length - 1) {
        setCurrentIndex(prev => prev + 1);
        setIsFlipped(false);
        setDragOffset({ x: 0, y: 0 });
      } else {
        setIsFinished(true);
      }
    }, 300);
  };

  // Swipe Handlers
  const onDragStart = (e) => {
    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
    setDragStart({ x: clientX, y: clientY });
    setIsDragging(true);
  };

  const onDragMove = (e) => {
    if (!isDragging) return;
    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
    setDragOffset({
      x: clientX - dragStart.x,
      y: clientY - dragStart.y
    });
  };

  const onDragEnd = () => {
    if (!isDragging) return;
    setIsDragging(false);

    const threshold = window.innerWidth * 0.3;
    if (dragOffset.x > threshold) {
      handleResponse(true); // Right Swipe
    } else if (dragOffset.x < -threshold) {
      handleResponse(false); // Left Swipe
    } else {
      // Tap detected if drag was minimal
      if (Math.abs(dragOffset.x) < 5 && Math.abs(dragOffset.y) < 5) {
        setIsFlipped(!isFlipped);
      }
      setDragOffset({ x: 0, y: 0 });
    }
  };

  if (currentDeck.length === 0) return null;

  const progress = (currentIndex / currentDeck.length) * 100;
  const rotation = dragOffset.x / 20;
  const opacityKnow = Math.min(dragOffset.x / 150, 1);
  const opacityAgain = Math.min(-dragOffset.x / 150, 1);

  return (
    <div className="min-h-screen bg-[#f8fafc] p-4 md:p-8 flex flex-col items-center font-sans text-[#1e293b] select-none touch-none overflow-hidden">
      <div className="max-w-md w-full">
        {/* Header */}
        <header className="mb-6 text-center">
          <h1 className="text-3xl font-black text-indigo-600 tracking-tight mb-1 italic">VOCAB MASTER</h1>
          <div className="text-slate-400 font-bold text-[10px] tracking-widest uppercase">
            Swipe Right: Know • Swipe Left: Again
          </div>
        </header>

        {!isFinished ? (
          <>
            {/* Category selection */}
            {!isReviewMode && (
              <div className="flex overflow-x-auto gap-2 no-scrollbar pb-4 mb-4 justify-start md:justify-center">
                {categories.map(cat => (
                  <button
                    key={cat}
                    onClick={() => setSelectedCategory(cat)}
                    className={`whitespace-nowrap px-4 py-1.5 rounded-full text-[10px] font-black transition-all border-2 ${
                      selectedCategory === cat 
                      ? "bg-indigo-600 border-indigo-600 text-white" 
                      : "bg-white border-slate-200 text-slate-500"
                    }`}
                  >
                    {cat.toUpperCase()}
                  </button>
                ))}
              </div>
            )}

            {/* Stats */}
            <div className="flex justify-between items-center mb-6 px-2">
              <div className="bg-white px-4 py-2 rounded-2xl border-b-4 border-slate-200 text-center min-w-[80px]">
                <span className="block text-[8px] font-black text-slate-400 uppercase">Progress</span>
                <span className="text-lg font-bold text-slate-700">{currentIndex + 1} / {currentDeck.length}</span>
              </div>
              <div className="flex gap-2">
                <div className="bg-green-50 px-3 py-2 rounded-xl text-center border border-green-100 min-w-[60px]">
                  <span className="block text-[8px] font-black text-green-600 uppercase">Know</span>
                  <span className="text-lg font-bold text-green-700">{learnedIds.size}</span>
                </div>
                <div className="bg-red-50 px-3 py-2 rounded-xl text-center border border-red-100 min-w-[60px]">
                  <span className="block text-[8px] font-black text-red-500 uppercase">Again</span>
                  <span className="text-lg font-bold text-red-700">{failedIds.size}</span>
                </div>
              </div>
            </div>

            {/* Swipeable Card */}
            <div className="relative w-full h-[450px] flex items-center justify-center">
              
              {/* Background Next Card (Visual stack) */}
              {currentIndex + 1 < currentDeck.length && (
                <div className="absolute w-[95%] h-[430px] bg-slate-200 rounded-[40px] transform translate-y-4 scale-95 opacity-50"></div>
              )}

              <div 
                ref={cardRef}
                onMouseDown={onDragStart}
                onMouseMove={onDragMove}
                onMouseUp={onDragEnd}
                onMouseLeave={onDragEnd}
                onTouchStart={onDragStart}
                onTouchMove={onDragMove}
                onTouchEnd={onDragEnd}
                style={{
                  transform: `translate(${dragOffset.x}px, ${dragOffset.y}px) rotate(${rotation}deg)`,
                  transition: isDragging ? 'none' : 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                }}
                className={`relative w-full h-full perspective-1000 transform-style-3d z-10`}
              >
                <div className={`relative w-full h-full transition-transform duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                  
                  {/* Know/Again Indicators */}
                  <div 
                    style={{ opacity: opacityKnow }}
                    className="absolute top-10 left-10 border-4 border-green-500 text-green-500 font-black text-3xl px-4 py-1 rounded-xl rotate-[-20deg] z-50 pointer-events-none"
                  >
                    KNOW
                  </div>
                  <div 
                    style={{ opacity: opacityAgain }}
                    className="absolute top-10 right-10 border-4 border-red-500 text-red-500 font-black text-3xl px-4 py-1 rounded-xl rotate-[20deg] z-50 pointer-events-none"
                  >
                    AGAIN
                  </div>

                  {/* Front (German) */}
                  <div className="absolute w-full h-full backface-hidden bg-white rounded-[40px] shadow-2xl flex flex-col items-center justify-center p-8 border-2 border-white">
                    <div className="absolute top-8 bg-indigo-50 text-indigo-500 px-4 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">
                      {currentDeck[currentIndex].cat}
                    </div>
                    <h2 className="text-3xl font-bold text-center text-slate-800 leading-tight">
                      {currentDeck[currentIndex].de}
                    </h2>
                    <div className="absolute bottom-8 flex flex-col items-center gap-1 opacity-20">
                      <span className="text-[10px] font-black uppercase tracking-widest">Tap for translation</span>
                    </div>
                  </div>

                  {/* Back (English) */}
                  <div className="absolute w-full h-full backface-hidden bg-indigo-600 text-white rounded-[40px] shadow-2xl flex flex-col items-center justify-center p-8 rotate-y-180 border-[8px] border-indigo-500">
                    <span className="text-indigo-200 text-xs font-black tracking-widest uppercase mb-4 opacity-50">Translation</span>
                    <h2 className="text-3xl font-black text-center leading-tight">
                      {currentDeck[currentIndex].en}
                    </h2>
                  </div>
                </div>
              </div>
            </div>

            <div className="mt-8 flex justify-center text-slate-400 font-bold text-[10px] uppercase tracking-[0.2em] animate-bounce">
              Swipe or Tap
            </div>
          </>
        ) : (
          /* Results Dashboard */
          <div className="bg-white rounded-[40px] shadow-2xl p-10 text-center animate-in zoom-in duration-500 border-b-[16px] border-indigo-50">
            <div className="w-24 h-24 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-8">
              {failedIds.size === 0 ? <Trophy size={48} /> : <Brain size={48} />}
            </div>
            
            <h2 className="text-3xl font-black mb-4 text-slate-800 uppercase">
              {failedIds.size === 0 ? "Excellent!" : "Session Done"}
            </h2>
            <p className="text-slate-500 font-semibold mb-10 text-sm leading-relaxed">
              {failedIds.size === 0 
                ? "Perfect score! You've mastered all words." 
                : `Learned ${learnedIds.size} words. ${failedIds.size} need more work.`}
            </p>
            
            <div className="space-y-4">
              {failedIds.size > 0 && (
                <button 
                  onClick={startReviewFailed}
                  className="w-full bg-amber-500 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-amber-600 transition-all flex items-center justify-center gap-2"
                >
                  <RotateCcw size={20} /> Review Mistakes
                </button>
              )}
              
              <button 
                onClick={() => startNewSession(selectedCategory)}
                className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2"
              >
                New Session <ChevronRight size={20} />
              </button>
              
              <button 
                onClick={() => { setSelectedCategory("Alle"); startNewSession("Alle"); }}
                className="w-full text-slate-400 py-2 font-black text-[10px] uppercase tracking-widest"
              >
                Reset App
              </button>
            </div>
          </div>
        )}
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
}